<?php
// Попробуем получить продукт разными способами и добавим отладочные сообщения

// Способ 1: Используем метод getSaleableItem()
$product = $block->getSaleableItem();
if ($product) {
    echo "DEBUG: Product found using getSaleableItem().";
} else {
    echo "DEBUG: No product found using getSaleableItem().";
}

// Способ 2: Пробуем получить продукт через объект Registry
$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$registry = $objectManager->get('Magento\Framework\Registry');
$productFromRegistry = $registry->registry('current_product');
if ($productFromRegistry) {
    $product = $productFromRegistry;
    echo "DEBUG: Product found using Registry (current_product).";
} else {
    echo "DEBUG: No product found using Registry (current_product).";
}

// Способ 3: Пробуем получить продукт через $_item, если он доступен в шаблоне
if (isset($_item)) {
    $product = $_item;
    echo "DEBUG: Product found using \$_item.";
} else {
    echo "DEBUG: No product found using \$_item.";
}

// Проверяем, если продукт успешно найден
if ($product) {
    echo "DEBUG: Final product found for calculation.";
    // Если продукт группированный, рассчитаем общую цену
    if ($product->getTypeId() === \Magento\GroupedProduct\Model\Product\Type\Grouped::TYPE_CODE) {
        $totalPrice = 0;
        $associatedProducts = $product->getTypeInstance()->getAssociatedProducts($product);
        foreach ($associatedProducts as $associatedProduct) {
            $totalPrice += $associatedProduct->getFinalPrice();
        }
        echo "DEBUG: Total price for grouped product calculated.";
    } else {
        echo "DEBUG: Product is not a grouped product.";
    }
} else {
    echo "DEBUG: No product found using any method.";
}
?>

<div class="price-box">
    <?php if (isset($totalPrice) && $totalPrice > 0): ?>
        <p class="minimal-price">
            <span class="price-label"><?= $block->escapeHtml(__('Total Price')) ?></span>
            <span class="price"><?= $block->escapeHtml(
                $this->priceHelper->currency($totalPrice, true, false)
            ); ?></span>
        </p>
    <?php else: ?>
        <?php echo "DEBUG: Price not rendered."; ?>
    <?php endif; ?>
</div>
